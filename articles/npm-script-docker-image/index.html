<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"/><meta name="og:site_name" content="JimLearningBlog"/><link rel="canonical" href="https://jimlearning.github.io/articles/npm-script-docker-image"/><meta name="twitter:url" content="https://jimlearning.github.io/articles/npm-script-docker-image"/><meta name="og:url" content="https://jimlearning.github.io/articles/npm-script-docker-image"/><title>Containerising a Node.js script | JimLearningBlog</title><meta name="twitter:title" content="Containerising a Node.js script | JimLearningBlog"/><meta name="og:title" content="Containerising a Node.js script | JimLearningBlog"/><meta name="description" content="When working inside a Continuous Integration (CI) and Continuous Delivery (CD) environment, portability of code is often a core concern that needs to be addressed. Developers write code locally and need some level of assurance that it will run consistently regardless of where it is deployed. This is an area where Docker shines. The goal of this post is to run a script, written with Node.js, inside a docker container. It assumes that you have an existing script which requires access to files on the local file system as well as an account on Docker Hub."/><meta name="twitter:description" content="When working inside a Continuous Integration (CI) and Continuous Delivery (CD) environment, portability of code is often a core concern that needs to be addressed. Developers write code locally and need some level of assurance that it will run consistently regardless of where it is deployed. This is an area where Docker shines. The goal of this post is to run a script, written with Node.js, inside a docker container. It assumes that you have an existing script which requires access to files on the local file system as well as an account on Docker Hub."/><meta name="og:description" content="When working inside a Continuous Integration (CI) and Continuous Delivery (CD) environment, portability of code is often a core concern that needs to be addressed. Developers write code locally and need some level of assurance that it will run consistently regardless of where it is deployed. This is an area where Docker shines. The goal of this post is to run a script, written with Node.js, inside a docker container. It assumes that you have an existing script which requires access to files on the local file system as well as an account on Docker Hub."/><meta name="twitter:card" content="summary"/><link rel="stylesheet" href="/styles.css" type="text/css"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link rel="shortcut icon" href="/images/favicon.png" type="image/png"/><link rel="alternate" href="/feed.rss" type="application/rss+xml" title="Subscribe to JimLearningBlog"/></head><head><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karla:400,400i,700,700i"/><link rel="stylesheet" href="/PersonalTheme/fontawesome/all.min.css"/></head><body class="item-page"><header><div class="wrapper"><a class="site-name" href="/">JimLearningBlog</a><p>A description of JimLearningBlog</p><nav><ul><li><a href="/posts"><span></span>Posts</a></li><li><a class="selected" href="/articles"><span class="far fa-newspaper"></span>Articles</a></li><li><a href="/tips"><span class="far fa-star"></span>Tips</a></li><li><a href="/apps"><span></span>Apps</a></li><li><a href="/tags"><span class="fas fa-hashtag"></span>Tags</a></li><li><a href="/about"><span class="far fa-user"></span>About Me</a></li></ul></nav></div></header><div class="wrapper"><article class="animated fadeIn"><span class="date">Published on 2019å¹´05æœˆ17æ—¥.</span><span class="read-time">ðŸ•‘ 4 minutes read.</span><h1>Containerising a Node.js script</h1><ul class="tag-list"><li class="tag variant-0"><a href="/tags/articles">Articles</a></li><li class="tag variant-3"><a href="/tags/docker">Docker</a></li><li class="tag variant-12"><a href="/tags/npm">NPM</a></li><li class="tag variant-2"><a href="/tags/cicd">CI/CD</a></li><li class="tag variant-13"><a href="/tags/raml">RAML</a></li></ul><p>When working inside a Continuous Integration (CI) and Continuous Delivery (CD) environment, portability of code is often a core concern that needs to be addressed. Developers write code locally and need some level of assurance that it will run consistently regardless of where it is deployed. This is an area where Docker shines. The goal of this post is to run a script, written with Node.js, inside a docker container. It assumes that you have an existing script which requires access to files on the local file system as well as an account on Docker Hub.</p><div class="content"><h2>Docker concepts</h2><p>To begin with, it's important to understand what Docker is and the principles behind it. Docker is a platform for <em>developers</em> and <em>system administrators</em> to develop, deploy and run applications with containers. The use of containers to deploy applications is called containerization, which is popular in CI and CD workflows because containers are<sup>[1]</sup>:</p><ul><li>Flexible - Any application can be containerized</li><li>Lightweight - They leverage and share the host kernel</li><li>Interchangeable - You can deploy updates and upgrades with zero down time</li><li>Portable - You can build locally and deploy to a server on premises or in the cloud</li><li>Scalable - You can scale your containers horizontally; increasing, decreasing or distributing replicas of them automatically</li><li>Stackable - You can stack your containers vertically, defining a stack declaratively</li></ul><p>In Docker a container is launched by running an image, and an image is an executable package that includes everything needed to run an application.</p><h2>Great.. so how do we create an image?</h2><p>To begin with, we will need to create file called <code>Dockerfile</code> in our working directory. A Dockerfile has a file format that contains instructions and arguments, which define the contents and startup behaviour of the Docker container. To run a Node.js script, our Dockerfile will need to contain the following, replacing <code>&lt;script-name&gt;</code> with the filename of your script:</p><pre><code># <span class="type">The</span> first instruction <span class="keyword">in</span> a <span class="type">Dockerfile</span> must be <span class="type">FROM</span>, which selects a base image. <span class="type">Since</span> it's recommended to use official <span class="type">Docker</span> images, we will use the official image <span class="keyword">for</span> node. <span class="type">We</span> will chose a specific image rather than defaulting to latest <span class="keyword">as</span> future node versions may <span class="keyword">break</span> our application.
<span class="type">FROM</span> node:<span class="number">12</span>-alpine

# <span class="type">Sets</span> the working directory to /usr/src/app.
<span class="type">WORKDIR</span> /usr/src/app

# <span class="type">Copies</span> the package file <span class="keyword">for</span> <span class="type">NPM</span> to the working directory.
<span class="type">COPY</span> package*.json ./

# <span class="type">Installs</span> the <span class="keyword">required</span> <span class="type">NPM</span> packages.
<span class="type">RUN</span> npm install

# <span class="type">Copies</span> the application from the current directory to the working directory of the image.
copy . .

# <span class="type">If</span> an action does not use the runs configuration option, the commands <span class="keyword">in</span> <span class="type">ENTRYPOINT</span> will execute. <span class="type">The Docker ENTRYPOINT</span> instruction has a shell form and exec form. <span class="type">We</span> will use the exec form of the <span class="type">ENTRYPOINT</span> instruction to call our node script. <span class="type">This</span> will allow us to pass arguments to the script when we run the container.
<span class="type">ENTRYPOINT</span> [<span class="string">"node"</span>, <span class="string">"&lt;script-name&gt;"</span>]
</code></pre><p>So the above <code>Dockerfile</code> will create a new image based on the official Node image, install our scripts NPM dependancies, copy the script to a working directory and when a container is started, automatically run the script. One thing we have overlooked is that since the <code>Dockerfile</code> installs NPM dependancies for us we shouldn't copy any node_modules into the image. To avoid this we can create a file called <code>.dockerignore</code> with the following contents:</p><pre><code>node_modules
</code></pre><p>With our <code>Dockerfile</code> and <code>.dockerignore</code> files in place, we can now build our image by running the following command and replacing <code>&lt;docker-hub-username&gt;</code> with your Docker Hub username and <code>&lt;image-name&gt;</code> with something memorable:</p><pre><code>sudo docker build \
  --no-cache \
  --tag <span class="string">"&lt;docker-hub-username&gt;/&lt;image-name&gt;:latest"</span> .
</code></pre><img src="/images/posts/npm-script-docker-build.svg" alt="Docker build screenshot"/><h2>Running our image</h2><p>Having built a Docker image, we can now run it locally by using the following command and replacing <code>&lt;docker-hub-username&gt;</code> with your Docker Hub username and <code>&lt;image-name&gt;</code> with the name used earlier:</p><pre><code>sudo docker run \
  --<span class="keyword">init</span> --rm \
  --volume $(pwd):/tmp \
  <span class="string">"&lt;docker-hub-username&gt;/&lt;image-name&gt;:latest"</span> &lt;image-args&gt;
</code></pre><img src="/images/posts/npm-script-docker-run.svg" alt="Docker run screenshot"/><p>For reference, the arguments we are passing through to Docker are:</p><ul><li><strong>init</strong>: sets the ENTRYPOINT to tini. tini is a lightweight init process which will help ensure that Node.js returns and responds to signals correctly</li><li><strong>rm</strong>: removes the container once it has finished running</li><li><strong>volume</strong>: mounts the specified location inside the container</li></ul><h2>Pushing our image to Docker Hub</h2><p>The final step of our journey is to publish our local docker image to Docker Hub so that we are able to pull and run it from other locations such as a CI/CD server. Before we can push our image we will need to login do Docker Hub by running the following command and entering our Docker Hub username and password when prompted:</p><pre><code>docker login
</code></pre><p>Once successfully authenticated, we can push our image by running the following command and replacing <code>&lt;docker-hub-username&gt;</code> with your Docker Hub username and <code>&lt;image-name&gt;</code> with the name used earlier:</p><pre><code>sudo docker \
  push <span class="string">"&lt;docker-hub-username&gt;/&lt;image-name&gt;:latest"</span>
</code></pre><img src="/images/posts/npm-script-docker-push.svg" alt="Docker push screenshot"/><p>Thats it! You can navigate to <code>https://hub.docker.com/r/&lt;docker-hub-username&gt;/&lt;image-name&gt;</code> to see your published image.</p><h2>References</h2><ul><li><a href="https://docs.docker.com/get-started/        "Docker"">Docker - Get Started</a></li></ul><p class="footer">Thanks for reading! ðŸš€</p></div><ul class="share grid compact"><li><a class="twitter" href="https://twitter.com/intent/tweet?via=MikeRyanGough&text=Containerising%20a%20Node.js%20script&url=https://jimlearning.github.ioarticles/npm-script-docker-image">Share on Twitter</a></li><li><a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://jimlearning.github.ioarticles/npm-script-docker-image">Share on Facebook</a></li><li><a class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&&titleContainerising%20a%20Node.js%20script=&summary=&source=&url=https://jimlearning.github.ioarticles/npm-script-docker-image">Share on LinkedIn</a></li></ul></article></div><footer class="animated fadeIn"><p>Mike Gough Â© 2020.</p><p>Powered by <a href="https://github.com/johnsundell/publish">Publish</a> and hosted on <a href="https://github.com/Mike-Gough/Mike-Gough.github.io">GitHub Pages</a>. 100% JavaScript-free.</p><p>Notice a broken link or other issue? <a href="https://github.com/Mike-Gough/Mike-Gough.github.io/issues">Open an issue!</a></p><p><a href="/feed.rss">RSS feed</a></p></footer></body></html>